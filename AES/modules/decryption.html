<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AES ë³µí˜¸í™” ë¼ìš´ë“œ ì‹œê°í™”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        .mono { font-family: 'Fira Code', monospace; }
        
        /* Grid Cell Styles */
        .state-cell {
            width: 1.8rem; height: 1.8rem;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #334155;
            font-size: 0.65rem; font-weight: bold; font-family: 'Fira Code', monospace;
            transition: all 0.3s ease;
        }
        @media (min-width: 768px) { .state-cell { width: 2rem; height: 2rem; font-size: 0.7rem; } }
        
        /* Key Cell Style */
        .key-cell {
            width: 1.8rem; height: 1.8rem;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #eab308; background-color: #422006; color: #fef08a;
            font-size: 0.65rem; font-weight: bold; font-family: 'Fira Code', monospace;
        }
        @media (min-width: 768px) { .key-cell { width: 2rem; height: 2rem; font-size: 0.7rem; } }

        /* Phases */
        .phase-shift { background-color: #1e293b; color: #fcd34d; }
        .phase-sub { background-color: #1e293b; color: #93c5fd; }
        .phase-key { background-color: #1e293b; color: #c4b5fd; }
        .phase-mix { background-color: #1e293b; color: #86efac; }
        .phase-init { background-color: #1e293b; color: #f472b6; border-color: #be185d; }
        
        /* Arrow Style */
        .arrow-right { 
            display: flex; align-items: center; justify-content: center; 
            color: #64748b; font-size: 1.5rem; font-weight: bold;
            padding: 0 0.5rem;
        }

        .operator { font-size: 1.5rem; font-weight: bold; color: #94a3b8; display: flex; align-items: center; justify-content: center; margin: 0 0.5rem; }

        /* Code Syntax */
        .c-key { color: #c678dd; font-weight: bold; } .c-type { color: #e5c07b; } .c-func { color: #61afef; }
        .c-var { color: #e06c75; } .c-num { color: #d19a66; } .c-com { color: #7f848e; font-style: italic; }
        
        .code-line { display: block; padding: 0 4px; border-radius: 2px; transition: background-color 0.2s; border-left: 3px solid transparent; }
        .code-active { background-color: #374151; color: #d8b4fe; font-weight: bold; border-left-color: #d8b4fe; } 
        .code-blink { animation: pulse-highlight 2s infinite; font-weight: bold; }
        @keyframes pulse-highlight { 0%, 100% { background-color: #374151; border-left-color: #d8b4fe; color: #d8b4fe; } 50% { background-color: transparent; border-left-color: transparent; color: #7f848e; } }

        /* Card Styles */
        .step-card { transition: all 0.2s; cursor: pointer; position: relative; min-width: 130px; /* ì¹´ë“œ ìµœì†Œ ë„ˆë¹„ í™•ë³´ */ }
        .step-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); border-color: #a78bfa; z-index: 10; }
        .step-card.active-card { border-color: #d8b4fe; box-shadow: 0 0 15px rgba(216, 180, 254, 0.3); }
        .step-card::after { content: 'ë³´ê¸°'; position: absolute; top: -10px; right: 5px; background: #7c3aed; color: white; font-size: 9px; padding: 2px 4px; border-radius: 4px; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .step-card:hover::after { opacity: 1; }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen bg-slate-900 pb-10">
    
    <a href="../index.html" class="home-btn"><span>ğŸ </span> Back</a>

    <div class="w-full max-w-[1600px] mb-4 flex flex-col md:flex-row justify-between items-center gap-4 mt-14 md:mt-6 px-4">
        <div class="text-center md:text-left">
            <h1 class="text-xl md:text-2xl font-bold text-purple-400 flex items-center justify-center md:justify-start gap-2">
                AES ë³µí˜¸í™” ë¼ìš´ë“œ
                <span class="text-[10px] bg-slate-700 text-slate-300 px-2 py-1 rounded font-normal">Inverse Cipher</span>
            </h1>
            <p class="text-slate-400 text-xs mt-1">
                ì•”í˜¸ë¬¸ì„ ì—­ìˆœìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ í‰ë¬¸ì„ ë³µì›í•©ë‹ˆë‹¤. (Key Round 10 â†’ 0)
            </p>
        </div>
        <a href="../index.html" class="text-slate-500 hover:text-white text-xs font-bold flex items-center bg-slate-800 px-3 py-2 rounded border border-slate-700 transition">
            ì „ì²´ êµ¬ì¡°ë„ ë³´ê¸°
        </a>
    </div>

    <main class="max-w-[1600px] w-full grid grid-cols-1 lg:grid-cols-12 gap-6 px-2 md:px-4">

        <div class="col-span-1 lg:col-span-8 space-y-4">
            
            <section class="bg-slate-800 rounded-xl p-3 border border-slate-700 shadow-lg flex flex-col gap-3">
                <div class="flex flex-col md:flex-row justify-between items-center border-b border-slate-700 pb-3 gap-3">
                    <div class="flex items-center gap-2 md:gap-4 w-full md:w-auto justify-between md:justify-start">
                        <div class="bg-slate-900 px-2 py-1.5 rounded-lg border border-slate-600 flex items-center gap-2 md:gap-3">
                            <label class="text-xs text-slate-400 font-bold">ROUND</label>
                            <button onclick="changeRound(-1)" class="text-slate-500 hover:text-white px-2">â—€</button>
                            <span id="currentRoundDisplay" class="w-8 md:w-12 text-center text-lg md:text-xl font-bold text-white mono">1</span>
                            <button onclick="changeRound(1)" class="text-slate-500 hover:text-white px-2">â–¶</button>
                        </div>
                        <div class="text-[10px] md:text-xs text-slate-500 text-right md:text-left">
                            <span class="text-purple-400 font-bold">Flow:</span> Shift â†’ Sub â†’ Add â†’ Mix
                        </div>
                    </div>
                    <button onclick="resetSimulation()" class="w-full md:w-auto bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold px-6 py-2 rounded shadow transition transform active:scale-95">
                        ì¬ì‹œì‘ â†»
                    </button>
                </div>

                <div class="flex flex-col md:flex-row gap-2 md:gap-4">
                    <div class="flex-1">
                        <div class="relative">
                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-purple-400 text-[10px] font-bold">KEY</span>
                            <input type="text" id="keyInput" 
                                value="2B7E151628AED2A6ABF7158809CF4F3C" maxlength="32" oninput="validateHex(this)"
                                class="pl-10 pr-2 py-2 bg-slate-900 border border-purple-500 rounded text-[10px] md:text-xs mono text-white w-full focus:outline-none focus:border-purple-400 uppercase tracking-widest">
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="relative">
                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-[10px] font-bold">DATA</span>
                            <input type="text" id="stateInput" 
                                value="3925841D02DC09FBDC118597196A0B32" maxlength="32" oninput="validateHex(this)"
                                class="pl-12 pr-2 py-2 bg-slate-900 border border-slate-500 rounded text-[10px] md:text-xs mono text-white w-full focus:outline-none focus:border-white uppercase tracking-widest">
                        </div>
                    </div>
                </div>
            </section>

            <section id="round0Panel" 
                     class="bg-pink-900/10 rounded-xl p-3 border border-pink-500/30 shadow-lg hidden step-card cursor-pointer"
                     onclick="showCode('add_round_key', this)">
                <h3 class="text-sm font-bold text-pink-400 mb-2 flex items-center justify-center md:justify-start gap-2">
                    <span class="bg-pink-500 text-white text-[10px] px-2 py-0.5 rounded">Pre-Round</span>
                    Initial Key Addition
                </h3>
                <div class="w-full overflow-x-auto custom-scrollbar pb-3">
                    <div class="flex items-center justify-start md:justify-center gap-2 min-w-max px-2">
                        <div id="r0-plain" class="grid grid-cols-4 gap-0.5"></div>
                        <div class="operator">âŠ•</div>
                        <div id="r0-key" class="grid grid-cols-4 gap-0.5 opacity-80"></div>
                        <div class="operator">=</div>
                        <div id="r0-result" class="grid grid-cols-4 gap-0.5 border border-pink-500/50 p-0.5 rounded"></div>
                    </div>
                </div>
            </section>

            <div class="bg-slate-800/30 border border-slate-700/50 rounded-xl overflow-hidden">
                <div class="w-full overflow-x-auto custom-scrollbar p-4">
                    <div class="flex gap-4 items-center justify-start md:justify-center min-w-max">
                        
                        <div class="bg-slate-800/80 p-2 rounded-xl border border-slate-600 flex flex-col items-center step-card active-card"
                             id="startCard" onclick="showCode('main', this)">
                            <h3 class="text-slate-300 font-bold mb-2 text-[10px]">Start</h3>
                            <div id="grid-start" class="grid grid-cols-4 gap-0.5"></div>
                        </div>

                        <div class="arrow-right">â†’</div>

                        <div class="bg-slate-800 p-2 rounded-xl border border-yellow-500/30 flex flex-col items-center step-card"
                             onclick="showCode('inv_shift_rows', this)">
                            <h3 class="text-yellow-300 font-bold mb-2 text-[10px]">1. Shift</h3>
                            <div id="grid-shift" class="grid grid-cols-4 gap-0.5"></div>
                        </div>

                        <div class="arrow-right">â†’</div>

                        <div class="bg-slate-800 p-2 rounded-xl border border-blue-500/30 flex flex-col items-center step-card"
                             onclick="showCode('inv_sub_bytes', this)">
                            <h3 class="text-blue-300 font-bold mb-2 text-[10px]">2. Sub</h3>
                            <div id="grid-sub" class="grid grid-cols-4 gap-0.5"></div>
                        </div>

                        <div class="arrow-right">â†’</div>

                        <div class="bg-slate-800 p-2 rounded-xl border border-purple-500/30 flex flex-col items-center step-card"
                             onclick="showCode('add_round_key', this)">
                            <h3 class="text-purple-300 font-bold mb-2 text-[10px]">3. Key</h3>
                            <div id="grid-key" class="grid grid-cols-4 gap-0.5"></div>
                        </div>

                        <div class="arrow-right">â†’</div>

                        <div class="bg-slate-800 p-2 rounded-xl border border-green-500/30 flex flex-col items-center step-card"
                             id="mixColContainer" onclick="showCode('inv_mix_columns', this)">
                            <h3 class="text-green-300 font-bold mb-2 text-[10px]">4. Mix</h3>
                            <div id="mixColActive"><div id="grid-mix" class="grid grid-cols-4 gap-0.5"></div></div>
                            <div id="mixColSkipped" class="hidden h-28 w-28 flex items-center justify-center border border-dashed border-slate-600 rounded text-slate-500 text-[10px]">SKIP</div>
                        </div>

                        <div class="arrow-right">â†’</div>

                        <div class="bg-slate-800/50 p-2 rounded-xl border border-slate-700 flex flex-col items-center step-card cursor-default" style="min-width:130px">
                            <h3 class="text-slate-400 font-bold mb-2 text-[10px]">End</h3>
                            <div id="grid-out" class="grid grid-cols-4 gap-0.5"></div>
                        </div>

                    </div>
                </div>
                <p class="text-center text-slate-500 text-xs mb-2 md:hidden">ğŸ‘† ì¢Œìš°ë¡œ ë°€ì–´ì„œ ì „ì²´ ê³¼ì •ì„ í™•ì¸í•˜ì„¸ìš”</p>
            </div>
        </div>

        <div class="col-span-1 lg:col-span-4 h-full flex flex-col gap-4 lg:sticky lg:top-4">
            
            <div class="bg-[#1e1e1e] rounded-xl shadow-xl overflow-hidden border border-slate-700 flex-1 flex flex-col min-h-[300px]">
                <div class="bg-[#252526] px-4 py-2 text-xs font-bold text-slate-400 border-b border-[#3e3e42] flex items-center justify-between">
                    <div class="flex items-center gap-2"><span class="text-purple-400">C Code</span><span id="codeTitle" class="text-white">aes_inv_cipher.c</span></div>
                </div>
                <div class="p-4 overflow-auto custom-scrollbar flex-1">
                    <pre><code id="codeDisplay" class="font-mono text-[10px] md:text-xs leading-relaxed text-gray-300 whitespace-pre"></code></pre>
                </div>
            </div>

            <div class="bg-slate-800 rounded-xl border border-yellow-500/50 p-4 shadow-lg shrink-0">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-yellow-300 font-bold text-sm">Round Key (Reverse)</h3>
                    <span class="text-[10px] bg-yellow-900/50 text-yellow-200 px-2 py-1 rounded mono">Round <span id="keyRoundDisp">10</span></span>
                </div>
                <p class="text-slate-400 text-[10px] mb-3 leading-relaxed">
                    Key Schedule: w[<span id="keyIndexStart">40</span>] ~ w[<span id="keyIndexEnd">43</span>]
                </p>
                <div class="flex justify-center">
                    <div id="rightKeyGrid" class="grid grid-cols-4 gap-1"></div>
                </div>
            </div>

        </div>

    </main>

    <script>
        const CODE_SNIPPETS = {
            main: `<span class="c-key">void</span> <span class="c-func">aes_inv_cipher</span>(uint8_t *in, uint8_t *out, uint8_t *w) {\n    uint8_t state[4*Nb];\n    uint8_t r, i, j;\n\n    <span class="c-com">// 1ë‹¨ê³„: ì…ë ¥ -> State ë³€í™˜</span>\n    <span class="c-key">for</span> (i = 0; i < 4; i++) {\n        <span class="c-key">for</span> (j = 0; j < Nb; j++) {\n            state[Nb*i+j] = in[i+4*j];\n        }\n    }\n\n    <span class="c-com">// 2ë‹¨ê³„: ì´ˆê¸° ë¼ìš´ë“œ í‚¤ ì¶”ê°€ (ë§ˆì§€ë§‰ ë¼ìš´ë“œ í‚¤ ì‚¬ìš©)</span>\n<span id="line-add-round-key-0" class="code-line">    <span class="c-func">add_round_key</span>(state, w, Nr);</span>\n\n<span id="line-step-3" class="code-line">    <span class="c-com">// 3ë‹¨ê³„: ì—­ ë¼ìš´ë“œ ë£¨í”„ (Nr-1 ë‹¤ìš´ ì¹´ìš´íŠ¸)</span></span>\n<span id="block-loop" class="code-line">    <span class="c-key">for</span> (r = Nr - 1; r >= 1; r--) {\n<span id="line-inv-shift" class="code-line">        <span class="c-func">inv_shift_rows</span>(state);</span>\n<span id="line-inv-sub" class="code-line">        <span class="c-func">inv_sub_bytes</span>(state);</span>\n<span id="line-add-round-key" class="code-line">        <span class="c-func">add_round_key</span>(state, w, r);</span>\n<span id="line-inv-mix" class="code-line">        <span class="c-func">inv_mix_columns</span>(state);</span>\n    }</span>\n\n    <span class="c-com">// 4ë‹¨ê³„: ë§ˆì§€ë§‰ ë¼ìš´ë“œ (InvMixColumns ì œì™¸)</span>\n<span id="block-final" class="code-line"><span id="line-final-shift" class="code-line">    <span class="c-func">inv_shift_rows</span>(state);</span>\n<span id="line-final-sub" class="code-line">    <span class="c-func">inv_sub_bytes</span>(state);</span>\n<span id="line-final-key" class="code-line">    <span class="c-func">add_round_key</span>(state, w, 0);</span></span>\n\n    <span class="c-com">// 5ë‹¨ê³„: ì¶œë ¥ ë³€í™˜</span>\n    <span class="c-key">for</span> (i = 0; i < 4; i++) {\n        <span class="c-key">for</span> (j = 0; j < Nb; j++) {\n            out[i+4*j] = state[Nb*i+j];\n        }\n    }\n}`,
            inv_sub_bytes: `<span class="c-key">void</span> <span class="c-func">inv_sub_bytes</span>(uint8_t *state) {\n    uint8_t i, j;\n    <span class="c-com">// ì—­ S-Box (inv_s_box)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¹˜í™˜</span>\n    <span class="c-key">for</span> (i = 0; i < 4; i++) {\n        <span class="c-key">for</span> (j = 0; j < Nb; j++) {\n            state[Nb*i+j] = inv_s_box[state[Nb*i+j]];\n        }\n    }\n}`,
            inv_shift_rows: `<span class="c-key">void</span> <span class="c-func">inv_shift_rows</span>(uint8_t *state) {\n    uint8_t i, k, s, tmp;\n    <span class="c-com">// ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìˆœí™˜ ì´ë™ (ì•”í˜¸í™”ì˜ ë°˜ëŒ€)</span>\n    <span class="c-key">for</span> (i = 1; i < 4; i++) {\n        s = 0;\n        <span class="c-key">while</span> (s < i) {\n            tmp = state[Nb*i+Nb-1]; <span class="c-com">// ë§ˆì§€ë§‰ ë°”ì´íŠ¸ ì €ì¥</span>\n            <span class="c-key">for</span> (k = Nb-1; k > 0; k--) {\n                state[Nb*i+k] = state[Nb*i+k-1];\n            }\n            state[Nb*i+0] = tmp;    <span class="c-com">// ì•ìœ¼ë¡œ ì´ë™</span>\n            s++;\n        }\n    }\n}`,
            inv_mix_columns: `<span class="c-key">void</span> <span class="c-func">inv_mix_columns</span>(uint8_t *state) {\n    <span class="c-com">// ë³µí˜¸í™”ìš© ë‹¤í•­ì‹: {0e}x^3 + {0b}x^2 + {0d}x + {09}</span>\n    uint8_t a[] = {0x0e, 0x0b, 0x0d, 0x09};\n    uint8_t i, j, col[4], res[4];\n\n    <span class="c-key">for</span> (j = 0; j < Nb; j++) {\n        <span class="c-key">for</span> (i = 0; i < 4; i++) col[i] = state[Nb*i+j];\n        \n        <span class="c-func">coef_mult</span>(a, col, res); <span class="c-com">// ê³±ì…ˆ ìˆ˜í–‰</span>\n        \n        <span class="c-key">for</span> (i = 0; i < 4; i++) state[Nb*i+j] = res[i];\n    }\n}`,
            add_round_key: `<span class="c-key">void</span> <span class="c-func">add_round_key</span>(uint8_t *state, uint8_t *w, uint8_t r) {\n    uint8_t c;\n    <span class="c-com">// XOR ì—°ì‚°ì€ ì•”í˜¸í™”ì™€ ë™ì¼ (A ^ B ^ B = A)</span>\n    <span class="c-key">for</span> (c = 0; c < Nb; c++) {\n        state[Nb*0+c] ^= w[4*Nb*r + 4*c + 0];\n        state[Nb*1+c] ^= w[4*Nb*r + 4*c + 1];\n        state[Nb*2+c] ^= w[4*Nb*r + 4*c + 2];\n        state[Nb*3+c] ^= w[4*Nb*r + 4*c + 3];\n    }\n}`
        };

        const SBOX = [0x63, 0x7c, 0x77, 0x7b, 0xf2, 0x6b, 0x6f, 0xc5, 0x30, 0x01, 0x67, 0x2b, 0xfe, 0xd7, 0xab, 0x76, 0xca, 0x82, 0xc9, 0x7d, 0xfa, 0x59, 0x47, 0xf0, 0xad, 0xd4, 0xa2, 0xaf, 0x9c, 0xa4, 0x72, 0xc0, 0xb7, 0xfd, 0x93, 0x26, 0x36, 0x3f, 0xf7, 0xcc, 0x34, 0xa5, 0xe5, 0xf1, 0x71, 0xd8, 0x31, 0x15, 0x04, 0xc7, 0x23, 0xc3, 0x18, 0x96, 0x05, 0x9a, 0x07, 0x12, 0x80, 0xe2, 0xeb, 0x27, 0xb2, 0x75, 0x09, 0x83, 0x2c, 0x1a, 0x1b, 0x6e, 0x5a, 0xa0, 0x52, 0x3b, 0xd6, 0xb3, 0x29, 0xe3, 0x2f, 0x84, 0x53, 0xd1, 0x00, 0xed, 0x20, 0xfc, 0xb1, 0x5b, 0x6a, 0xcb, 0xbe, 0x39, 0x4a, 0x4c, 0x58, 0xcf, 0xd0, 0xef, 0xaa, 0xfb, 0x43, 0x4d, 0x33, 0x85, 0x45, 0xf9, 0x02, 0x7f, 0x50, 0x3c, 0x9f, 0xa8, 0x51, 0xa3, 0x40, 0x8f, 0x92, 0x9d, 0x38, 0xf5, 0xbc, 0xb6, 0xda, 0x21, 0x10, 0xff, 0xf3, 0xd2, 0xcd, 0x0c, 0x13, 0xec, 0x5f, 0x97, 0x44, 0x17, 0xc4, 0xa7, 0x7e, 0x3d, 0x64, 0x5d, 0x19, 0x73, 0x60, 0x81, 0x4f, 0xdc, 0x22, 0x2a, 0x90, 0x88, 0x46, 0xee, 0xb8, 0x14, 0xde, 0x5e, 0x0b, 0xdb, 0xe0, 0x32, 0x3a, 0x0a, 0x49, 0x06, 0x24, 0x5c, 0xc2, 0xd3, 0xac, 0x62, 0x91, 0x95, 0xe4, 0x79, 0xe7, 0xc8, 0x37, 0x6d, 0x8d, 0xd5, 0x4e, 0xa9, 0x6c, 0x56, 0xf4, 0xea, 0x65, 0x7a, 0xae, 0x08, 0xba, 0x78, 0x25, 0x2e, 0x1c, 0xa6, 0xb4, 0xc6, 0xe8, 0xdd, 0x74, 0x1f, 0x4b, 0xbd, 0x8b, 0x8a, 0x70, 0x3e, 0xb5, 0x66, 0x48, 0x03, 0xf6, 0x0e, 0x61, 0x35, 0x57, 0xb9, 0x86, 0xc1, 0x1d, 0x9e, 0xe1, 0xf8, 0x98, 0x11, 0x69, 0xd9, 0x8e, 0x94, 0x9b, 0x1e, 0x87, 0xe9, 0xce, 0x55, 0x28, 0xdf, 0x8c, 0xa1, 0x89, 0x0d, 0xbf, 0xe6, 0x42, 0x68, 0x41, 0x99, 0x2d, 0x0f, 0xb0, 0x54, 0xbb, 0x16];
        const INV_SBOX = [0x52,0x09,0x6a,0xd5,0x30,0x36,0xa5,0x38,0xbf,0x40,0xa3,0x9e,0x81,0xf3,0xd7,0xfb,0x7c,0xe3,0x39,0x82,0x9b,0x2f,0xff,0x87,0x34,0x8e,0x43,0x44,0xc4,0xde,0xe9,0xcb,0x54,0x7b,0x94,0x32,0xa6,0xc2,0x23,0x3d,0xee,0x4c,0x95,0x0b,0x42,0xfa,0xc3,0x4e,0x08,0x2e,0xa1,0x66,0x28,0xd9,0x24,0xb2,0x76,0x5b,0xa2,0x49,0x6d,0x8b,0xd1,0x25,0x72,0xf8,0xf6,0x64,0x86,0x68,0x98,0x16,0xd4,0xa4,0x5c,0xcc,0x5d,0x65,0xb6,0x92,0x6c,0x70,0x48,0x50,0xfd,0xed,0xb9,0xda,0x5e,0x15,0x46,0x57,0xa7,0x8d,0x9d,0x84,0x90,0xd8,0xab,0x00,0x8c,0xbc,0xd3,0x0a,0xf7,0xe4,0x58,0x05,0xb8,0xb3,0x45,0x06,0xd0,0x2c,0x1e,0x8f,0xca,0x3f,0x0f,0x02,0xc1,0xaf,0xbd,0x03,0x01,0x13,0x8a,0x6b,0x3a,0x91,0x11,0x41,0x4f,0x67,0xdc,0xea,0x97,0xf2,0xcf,0xce,0xf0,0xb4,0xe6,0x73,0x96,0xac,0x74,0x22,0xe7,0xad,0x35,0x85,0xe2,0xf9,0x37,0xe8,0x1c,0x75,0xdf,0x6e,0x47,0xf1,0x1a,0x71,0x1d,0x29,0xc5,0x89,0x6f,0xb7,0x62,0x0e,0xaa,0x18,0xbe,0x1b,0xfc,0x56,0x3e,0x4b,0xc6,0xd2,0x79,0x20,0x9a,0xdb,0xc0,0xfe,0x78,0xcd,0x5a,0xf4,0x1f,0xdd,0xa8,0x33,0x88,0x07,0xc7,0x31,0xb1,0x12,0x10,0x59,0x27,0x80,0xec,0x5f,0x60,0x51,0x7f,0xa9,0x19,0xb5,0x4a,0x0d,0x2d,0xe5,0x7a,0x9f,0x93,0xc9,0x9c,0xef,0xa0,0xe0,0x3b,0x4d,0xae,0x2a,0xf5,0xb0,0xc8,0xeb,0xbb,0x3c,0x83,0x53,0x99,0x61,0x17,0x2b,0x04,0x7e,0xba,0x77,0xd6,0x26,0xe1,0x69,0x14,0x63,0x55,0x21,0x0c,0x7d];
        const RCON = [0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x1b, 0x36];

        function gmult(a, b) {
            let p = 0;
            for (let i = 0; i < 8; i++) {
                if ((b & 1) !== 0) p ^= a;
                let hi_bit = (a & 0x80);
                a = (a << 1) & 0xFF;
                if (hi_bit) a ^= 0x1b;
                b >>= 1;
            }
            return p;
        }

        function toHex(val) { return val.toString(16).toUpperCase().padStart(2, '0'); }
        function fromHex(str) { return str.match(/.{1,2}/g).map(byte => parseInt(byte, 16)); }
        
        function invSubBytes(state) { return state.map(b => INV_SBOX[b]); }
        
        function invShiftRows(s) {
            let out = [...s];
            let temp = out[13]; out[13] = out[9]; out[9] = out[5]; out[5] = out[1]; out[1] = temp;
            temp = out[2]; out[2] = out[10]; out[10] = temp;
            temp = out[6]; out[6] = out[14]; out[14] = temp;
            temp = out[3]; out[3] = out[7]; out[7] = out[11]; out[11] = out[15]; out[15] = temp;
            return out;
        }

        function invMixColumns(s) {
            let out = new Array(16);
            for (let c = 0; c < 4; c++) { 
                let start = c * 4;
                let s0 = s[start], s1 = s[start+1], s2 = s[start+2], s3 = s[start+3];
                out[start]   = gmult(s0, 0x0e) ^ gmult(s1, 0x0b) ^ gmult(s2, 0x0d) ^ gmult(s3, 0x09);
                out[start+1] = gmult(s0, 0x09) ^ gmult(s1, 0x0e) ^ gmult(s2, 0x0b) ^ gmult(s3, 0x0d);
                out[start+2] = gmult(s0, 0x0d) ^ gmult(s1, 0x09) ^ gmult(s2, 0x0e) ^ gmult(s3, 0x0b);
                out[start+3] = gmult(s0, 0x0b) ^ gmult(s1, 0x0d) ^ gmult(s2, 0x09) ^ gmult(s3, 0x0e);
            }
            return out;
        }

        function expandKey(masterKey) {
            let w = new Array(44); 
            for(let i=0; i<4; i++) w[i] = [masterKey[4*i], masterKey[4*i+1], masterKey[4*i+2], masterKey[4*i+3]];
            for(let i=4; i<44; i++) {
                let temp = [...w[i-1]];
                if(i % 4 === 0) {
                    temp.push(temp.shift());
                    temp = temp.map(b => SBOX[b]);
                    temp[0] ^= RCON[(i/4)-1];
                }
                w[i] = [w[i-4][0]^temp[0], w[i-4][1]^temp[1], w[i-4][2]^temp[2], w[i-4][3]^temp[3]];
            }
            return w; 
        }
        function addRoundKey(state, roundKey) { return state.map((b, i) => b ^ roundKey[i]); }

        let currentState = [];
        let masterKey = [];
        let expandedKeys = [];
        let currentRound = 1;

        function showCode(type, element) {
            const display = document.getElementById('codeDisplay');
            const title = document.getElementById('codeTitle');
            
            document.querySelectorAll('.step-card').forEach(el => el.classList.remove('active-card'));
            if(element) element.classList.add('active-card');
            
            display.innerHTML = CODE_SNIPPETS[type];
            
            if (type === 'main') {
                title.innerText = 'aes_inv_cipher.c';
                setTimeout(updateCodeActiveState, 10);
            }
            else title.innerText = type + '.c (Detail)';

            if (element && element.id === 'round0Panel') {
                updateKeyPanel(10); 
            } else {
                updateKeyPanel(); 
            }
        }

        function updateCodeActiveState() {
            if(document.getElementById('codeTitle').innerText !== 'aes_inv_cipher.c') return;

            document.querySelectorAll('.code-line').forEach(el => {
                el.classList.remove('code-active');
                el.classList.remove('code-blink'); 
            });

            if (currentRound === 1) {
                document.getElementById('line-step-3')?.classList.add('code-blink');
            } else if (currentRound < 10) {
                document.getElementById('block-loop')?.classList.add('code-active');
            } else {
                document.getElementById('block-final')?.classList.add('code-active');
            }
        }

        function updateKeyPanel(specificRound = null) {
            let encKeyRound;
            
            if (specificRound !== null) {
                encKeyRound = specificRound; 
            } else {
                encKeyRound = 10 - currentRound;
            }
            
            const startIdx = encKeyRound * 4;
            const endIdx = startIdx + 3;
            
            document.getElementById('keyRoundDisp').innerText = encKeyRound;
            document.getElementById('keyIndexStart').innerText = startIdx;
            document.getElementById('keyIndexEnd').innerText = endIdx;

            const roundKeyWords = expandedKeys.slice(startIdx, endIdx + 1);
            const roundKey = roundKeyWords.flat();

            const container = document.getElementById('rightKeyGrid');
            container.innerHTML = '';
            
            for(let r=0; r<4; r++) {
                for(let c=0; c<4; c++) {
                    const val = roundKey[c*4 + r];
                    const div = document.createElement('div');
                    div.className = 'key-cell';
                    div.innerText = toHex(val);
                    container.appendChild(div);
                }
            }
        }

        function validateHex(el) {
            let val = el.value.replace(/[^0-9A-Fa-f]/g, '').toUpperCase();
            el.value = val;
            if (val.length === 32) {
                el.classList.replace('border-slate-500', 'border-purple-500');
            }
        }

        function renderGrid(containerId, data, colorClass) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            for(let r=0; r<4; r++) {
                for(let c=0; c<4; c++) {
                    const idx = c*4 + r; 
                    const val = data[idx];
                    const div = document.createElement('div');
                    div.className = `state-cell ${colorClass}`;
                    div.innerText = toHex(val);
                    container.appendChild(div);
                }
            }
        }

        function calculateDecryptionRound(startState, round) {
            const keyRound = 10 - round;
            const keyStart = keyRound * 4;
            const roundKeyWords = expandedKeys.slice(keyStart, keyStart+4);
            const roundKey = roundKeyWords.flat();

            const afterShift = invShiftRows(startState);
            const afterSub = invSubBytes(afterShift);
            const afterAdd = addRoundKey(afterSub, roundKey);
            
            let afterMix;
            if (round < 10) afterMix = invMixColumns(afterAdd);
            else afterMix = [...afterAdd];

            return { start: startState, shift: afterShift, sub: afterSub, add: afterAdd, mix: afterMix, out: afterMix, key: roundKey };
        }

        function updateUI() {
            document.getElementById('currentRoundDisplay').innerText = `${currentRound}`;
            
            const mixActive = document.getElementById('mixColActive');
            const mixSkip = document.getElementById('mixColSkipped');
            if (currentRound === 10) {
                mixActive.classList.add('hidden');
                mixSkip.classList.remove('hidden');
            } else {
                mixActive.classList.remove('hidden');
                mixSkip.classList.add('hidden');
            }
            
            const round0Panel = document.getElementById('round0Panel');
            if (currentRound === 1) {
                round0Panel.classList.remove('hidden');
                const cipherText = [...currentState];
                const key10Words = expandedKeys.slice(40, 44);
                const key10 = key10Words.flat();
                const r0Result = addRoundKey(cipherText, key10);
                
                renderGrid('r0-plain', cipherText, 'text-slate-300 bg-slate-700/50');
                renderGrid('r0-key', key10, 'phase-key');
                renderGrid('r0-result', r0Result, 'phase-init text-pink-200');
            } else {
                round0Panel.classList.add('hidden');
            }

            showCode('main', document.getElementById('startCard'));
            updateKeyPanel();

            let state = [...currentState]; 
            const key10Words = expandedKeys.slice(40, 44);
            state = addRoundKey(state, key10Words.flat());

            for(let r=1; r < currentRound; r++) {
                 const res = calculateDecryptionRound(state, r);
                 state = res.out;
            }

            const roundData = calculateDecryptionRound(state, currentRound);
            
            renderGrid('grid-start', roundData.start, 'text-slate-300 bg-slate-700/50');
            renderGrid('grid-shift', roundData.shift, 'phase-shift');
            renderGrid('grid-sub', roundData.sub, 'phase-sub');
            renderGrid('grid-key', roundData.add, 'phase-key'); 
            if (currentRound < 10) renderGrid('grid-mix', roundData.mix, 'phase-mix');
            renderGrid('grid-out', roundData.out, 'text-green-300 bg-slate-700 border-green-500');
        }

        function changeRound(delta) {
            let next = currentRound + delta;
            if (next < 1) next = 1;
            if (next > 10) next = 10;
            currentRound = next;
            updateUI();
        }

        function resetSimulation() {
            const keyHex = document.getElementById('keyInput').value;
            const stateHex = document.getElementById('stateInput').value;
            
            if(keyHex.length !== 32) { alert('Key 32ìë¦¬ Hex í™•ì¸ í•„ìš”'); return; }
            if(stateHex.length !== 32) { alert('Data 32ìë¦¬ Hex í™•ì¸ í•„ìš”'); return; }
            
            masterKey = fromHex(keyHex);
            currentState = fromHex(stateHex);
            expandedKeys = expandKey(masterKey);
            currentRound = 1;
            updateUI();
        }

        window.onload = resetSimulation;
    </script>
</body>
</html>
